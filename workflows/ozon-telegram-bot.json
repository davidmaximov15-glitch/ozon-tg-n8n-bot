{
  "name": "Ozon Telegram Bot - Orders Analytics (patched)",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {
          "download": true
        }
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ],
      "id": "a1b2c3d4-1234-5678-9abc-def012345678",
      "name": "Telegram Trigger",
      "credentials": {
        "telegramApi": {
          "id": "p4dTUZho7h1VsmzM",
          "name": "Tg Ozon.Orders bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram-bot-token-field",
              "name": "TELEGRAM_BOT_TOKEN",
              "value": "YOUR_TELEGRAM_BOT_TOKEN_HERE",
              "type": "string"
            },
            {
              "id": "superuser-ids-field",
              "name": "SUPERUSER_IDS",
              "value": "user_id_1,user_id_2",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        480,
        300
      ],
      "id": "config-set-node-001",
      "name": "Config"
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð˜\n\nconst token = $json.TELEGRAM_BOT_TOKEN;\nconst superusers = $json.SUPERUSER_IDS;\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð°\nif (!token || token === 'YOUR_TELEGRAM_BOT_TOKEN_HERE') {\n  throw new Error('âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² Config node');\n}\n\n// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° superusers\nif (!superusers || superusers.trim() === '' || superusers === 'user_id_1,user_id_2') {\n  throw new Error('âŒ SUPERUSER_IDS Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð² Config node (Ð·Ð°Ð¼ÐµÐ½Ð¸ user_id_1,user_id_2 Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ID)');\n}\n\n// ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð»ÑŒÑˆÐµ (Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ ÑÐ¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸)\nreturn {\n  json: $json,\n  binary: $binary\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        300
      ],
      "id": "validate-config-node-001",
      "name": "Validate Config"
    },
    {
      "parameters": {
        "jsCode": "// Extract user data from Telegram Trigger\nconst telegramData = $('Telegram Trigger').first().json;\nconst message = telegramData.message;\nconst callback = telegramData.callback_query;\n\nconst userId = message?.from?.id || callback?.from?.id;\nconst chatId = message?.chat?.id || callback?.message?.chat?.id;\nconst messageText = message?.text || '';\nconst callbackData = callback?.data || '';\nconst document = message?.document || null;\n\n// ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ Ñ‚ÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸ÑˆÐ»Ð¾ (Config Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Validate Config)\nreturn {\n  json: {\n    ...$json,  // Config Ð´Ð°Ð½Ð½Ñ‹Ðµ (TELEGRAM_BOT_TOKEN, SUPERUSER_IDS)\n    user_id: String(userId),\n    chat_id: String(chatId),\n    message_text: messageText,\n    callback_data: callbackData,\n    document: document\n  },\n  binary: $binary\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        300
      ],
      "id": "b2c3d4e5-2345-6789-abcd-ef0123456789",
      "name": "Extract User Data"
    },
    {
      "parameters": {
        "operation": "csv",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1780,
        420
      ],
      "id": "extract-from-file-001",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=ozon:acl:whitelist:{{ $json.user_id }}",
        "propertyName": "value"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        680,
        300
      ],
      "id": "c3d4e5f6-3456-7890-bcde-f01234567890",
      "name": "Check Whitelist",
      "credentials": {
        "redis": {
          "id": "kaA0Glj8bB5pwqRt",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "is-superuser-or-admin",
              "leftValue": "={{ $json.is_superuser === true || $json.is_admin === true }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        900,
        300
      ],
      "id": "d4e5f6a7-4567-8901-cdef-012345678901",
      "name": "Is Authorized?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extract User Data').first().json.chat_id }}",
        "text": "â›” Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½. Ð’Ñ‹ Ð½Ðµ Ð² Ð±ÐµÐ»Ð¾Ð¼ ÑÐ¿Ð¸ÑÐºÐµ.\n\nÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1120,
        460
      ],
      "id": "e5f6a7b8-5678-9012-def0-123456789012",
      "name": "Unauthorized Response",
      "credentials": {
        "telegramApi": {
          "id": "p4dTUZho7h1VsmzM",
          "name": "Tg Ozon.Orders bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=ozon:acl:admins:{{ $('Extract User Data').first().json.user_id }}",
        "propertyName": "value"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1120,
        140
      ],
      "id": "f6a7b8c9-6789-0123-ef01-234567890123",
      "name": "Check Admin",
      "credentials": {
        "redis": {
          "id": "kaA0Glj8bB5pwqRt",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cond-start",
                    "leftValue": "={{ $('Extract User Data').first().json.message_text }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cond-csv-mime1",
                    "leftValue": "={{ $('Extract User Data').first().json.document?.mime_type }}",
                    "rightValue": "text/csv",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "cond-csv-mime2",
                    "leftValue": "={{ $('Extract User Data').first().json.document?.mime_type }}",
                    "rightValue": "application/vnd.ms-excel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "cond-csv-ext",
                    "leftValue": "={{ $('Extract User Data').first().json.document?.file_name }}",
                    "rightValue": ".csv",
                    "operator": {
                      "type": "string",
                      "operation": "endsWith"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "CSV"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cond-menu",
                    "leftValue": "={{ $('Extract User Data').first().json.callback_data }}",
                    "rightValue": "menu:",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cond-date",
                    "leftValue": "={{ $('Extract User Data').first().json.callback_data }}",
                    "rightValue": "date:",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DateSelection"
            }
          ]
        },
        "options": {
          "fallbackOutput": "none"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1340,
        140
      ],
      "id": "a7b8c9d0-7890-1234-f012-345678901234",
      "name": "Route Message"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $('Extract User Data').first().json.chat_id;\nconst isAdmin = $('Check Admin').first().json.value === '1';\n\nconst keyboard = {\n  inline_keyboard: [\n    [{text: 'ðŸ“¦ Ð—Ð°ÐºÐ°Ð·Ñ‹', callback_data: 'menu:orders'}],\n    [{text: 'ðŸŽ¯ ÐšÐ»Ð°ÑÑ‚ÐµÑ€Ñ‹', callback_data: 'menu:clusters'}]\n  ]\n};\n\nif (isAdmin) {\n  keyboard.inline_keyboard.push([{text: 'âš™ï¸ ÐÐ´Ð¼Ð¸Ð½ÐºÐ°', callback_data: 'menu:admin'}]);\n}\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    text: 'ðŸ¤– **Ozon Analytics Bot**\\n\\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»:',\n    reply_markup: keyboard\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        60
      ],
      "id": "b8c9d0e1-8901-2345-0123-456789012345",
      "name": "Generate Main Menu"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $('Extract User Data').first().json.chat_id;\nconst callbackData = $('Extract User Data').first().json.callback_data;\nconst isAdmin = $('Check Admin').first().json.value === '1';\n\nconst action = callbackData.replace('menu:', '');\n\nlet text = '';\nlet keyboard = {inline_keyboard: [[{text: 'Â« ÐÐ°Ð·Ð°Ð´', callback_data: '/start'}]]};\n\nif (action === 'orders') {\n  text = 'ðŸ“¦ **Ð Ð°Ð·Ð´ÐµÐ»: Ð—Ð°ÐºÐ°Ð·Ñ‹**\\n\\nÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ CSV Ñ„Ð°Ð¹Ð» Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð¼ Ozon (FBO Ð¸Ð»Ð¸ FBS) Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°.\\n\\n*Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚:* Ð´Ð¾ 20MB, .csv';\n} else if (action === 'clusters') {\n  text = 'ðŸŽ¯ **Ð Ð°Ð·Ð´ÐµÐ»: ÐšÐ»Ð°ÑÑ‚ÐµÑ€Ñ‹**\\n\\nðŸš§ Ð’ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ.';\n} else if (action === 'admin' && isAdmin) {\n  text = 'âš™ï¸ **ÐÐ´Ð¼Ð¸Ð½ÐºÐ°**\\n\\nÐ£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼:';\n  keyboard = {\n    inline_keyboard: [\n      [{text: 'ðŸ‘¥ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸', callback_data: 'admin:users'}],\n      [{text: 'Â« ÐÐ°Ð·Ð°Ð´', callback_data: '/start'}]\n    ]\n  };\n}\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    text: text,\n    reply_markup: keyboard\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        240
      ],
      "id": "d0e1f2a3-0123-4567-2345-678901234567",
      "name": "Handle Menu"
    },
    {
      "parameters": {
        "jsCode": "// === Ð§Ð¢Ð•ÐÐ˜Ð• ÐŸÐžÐ¡Ð›Ð• Extract from File ===\nconst rows = $input.all().map(i => i.json.row ?? i.json).filter(Boolean);\nif (rows.length === 0) {\n  throw new Error('Extract from File Ð½Ðµ Ð²ÐµÑ€Ð½ÑƒÐ» Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸');\n}\n\nconst keysLower = Object.keys(rows[0]).map(k => k.toLowerCase());\nfunction detectReportType(keys) {\n  const isFBS = keys.some(k => k.includes('ÑÐ¿Ð¾ÑÐ¾Ð± Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸') || k.includes('Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·Ñ‡Ð¸Ðº') || k.includes('Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ð°') || k.includes('Ð´Ð°Ñ‚Ð° Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð±ÐµÐ· Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸'));\n  const isFBO = keys.some(k => k.includes('ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð»Ð¸Ñ†Ð¾') || k.includes('Ð¾Ñ†ÐµÐ½ÐºÐ° Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸'));\n  if (isFBS) return 'FBS';\n  if (isFBO) return 'FBO';\n  return 'UNKNOWN';\n}\nconst reportType = detectReportType(keysLower);\nif (reportType === 'UNKNOWN') {\n  throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð¿Ð¾ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ°Ð¼');\n}\n\nfunction pick(obj, names, fallback = '') {\n  for (const n of names) {\n    if (obj[n] !== undefined && String(obj[n]).trim() !== '') return obj[n];\n  }\n  return fallback;\n}\n\nconst records = [];\nfor (const r of rows) {\n  let order_id, sku, quantity, price, created_at, status;\n  if (reportType === 'FBO') {\n    order_id   = pick(r, ['ÐÐ¾Ð¼ÐµÑ€ Ð·Ð°ÐºÐ°Ð·Ð°']);\n    sku        = pick(r, ['ÐÑ€Ñ‚Ð¸ÐºÑƒÐ»', 'OZON id']);\n    quantity   = Number(pick(r, ['ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾'], 1));\n    price      = Number(pick(r, ['Ð’Ð°ÑˆÐ° Ñ†ÐµÐ½Ð°', 'Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ'], 0));\n    created_at = pick(r, ['ÐŸÑ€Ð¸Ð½ÑÑ‚ Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ','Ð”Ð°Ñ‚Ð° Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸','Ð¤Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð´Ð°Ñ‚Ð° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð² Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ']);\n    status     = pick(r, ['Ð¡Ñ‚Ð°Ñ‚ÑƒÑ'], '');\n  } else {\n    order_id   = pick(r, ['ÐÐ¾Ð¼ÐµÑ€ Ð·Ð°ÐºÐ°Ð·Ð°','â„– Ð·Ð°ÐºÐ°Ð·Ð°']);\n    sku        = pick(r, ['ÐÑ€Ñ‚Ð¸ÐºÑƒÐ»','ÐÑ€Ñ‚Ð¸ÐºÑƒÐ» Ð¿Ñ€Ð¾Ð´Ð°Ð²Ñ†Ð°','OZON id']);\n    quantity   = Number(pick(r, ['ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾','ÐšÐ¾Ð»-Ð²Ð¾'], 1));\n    price      = Number(pick(r, ['Ð’Ð°ÑˆÐ° Ñ†ÐµÐ½Ð°','Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ'], 0));\n    created_at = pick(r, ['ÐŸÑ€Ð¸Ð½ÑÑ‚ Ð² Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ','Ð”Ð°Ñ‚Ð° Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸','Ð”Ð°Ñ‚Ð° Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð±ÐµÐ· Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ¸']);\n    status     = pick(r, ['Ð¡Ñ‚Ð°Ñ‚ÑƒÑ'], '');\n  }\n  if (!order_id || !sku) continue;\n  records.push({\n    order_id,\n    sku,\n    quantity: Number.isFinite(quantity) ? quantity : 1,\n    price: Number.isFinite(price) ? price : 0,\n    created_at,\n    status: String(status || '').toLowerCase(),\n  });\n}\n\nconst dates = new Set();\nfor (const rec of records) {\n  if (!rec.created_at) continue;\n  const d = new Date(rec.created_at);\n  if (isNaN(d)) continue;\n  const msk = new Date(d.getTime() + 3 * 60 * 60 * 1000);\n  dates.add(msk.toISOString().split('T')[0]);\n}\n\nconst availableDates = Array.from(dates).sort();\nconst chatId = $('Extract User Data').first().json.chat_id;\nconst userId = $('Extract User Data').first().json.user_id;\n\nreturn [{\n  json: {\n    reportType,\n    records,\n    availableDates,\n    totalRecords: records.length,\n    chat_id: chatId,\n    user_id: userId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        420
      ],
      "id": "parse-csv-node",
      "name": "Parse CSV"
    },
    {
      "parameters": {
        "jsCode": "const parsedData = $input.first().json;\nconst availableDates = parsedData.availableDates;\n\nif (availableDates.length === 0) {\n  return [{\n    json: {\n      chat_id: parsedData.chat_id,\n      text: 'âŒ Ð’ Ñ„Ð°Ð¹Ð»Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´Ð°Ñ‚Ñ‹',\n      reply_markup: null\n    }\n  }];\n}\n\nconst keyboard = {\n  inline_keyboard: availableDates.slice(0, 10).map(date => [{\n    text: date,\n    callback_data: `date:${date}`\n  }])\n};\n\nreturn [{\n  json: {\n    chat_id: parsedData.chat_id,\n    text: `ðŸ“… Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð°Ñ‚Ñƒ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n\nÐ¢Ð¸Ð¿ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°: ${parsedData.reportType}\nÐ’ÑÐµÐ³Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: ${parsedData.totalRecords}`,\n    reply_markup: keyboard\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2440,
        420
      ],
      "id": "date-keyboard-node",
      "name": "Generate Date Keyboard"
    },
    {
      "parameters": {
        "jsCode": "function filterRecordsByDateTime(records, date, startTime, endTime) {\n  return records.filter(record => {\n    try {\n      const recordDate = new Date(record.created_at);\n      const mskDate = new Date(recordDate.getTime() + 3 * 60 * 60 * 1000);\n      const recordDateStr = mskDate.toISOString().split('T')[0];\n      const recordTimeStr = mskDate.toTimeString().split(' ')[0].substring(0, 5);\n      \n      return recordDateStr === date && recordTimeStr >= startTime && recordTimeStr <= endTime;\n    } catch (e) {\n      return false;\n    }\n  });\n}\n\nfunction calculateStatistics(records, date, startTime, endTime) {\n  const filteredRecords = filterRecordsByDateTime(records, date, startTime, endTime);\n  \n  if (filteredRecords.length === 0) {\n    return {\n      date, startTime, endTime,\n      totalOrders: 0,\n      totalCancellations: 0,\n      totalRevenue: 0,\n      skuStats: {},\n      message: 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´'\n    };\n  }\n\n  const statsBySku = {};\n  const revenueStatuses = ['Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½', 'Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ÑÑ', 'Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ ÑÐ±Ð¾Ñ€ÐºÐ¸', 'Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ Ð¾Ñ‚Ð³Ñ€ÑƒÐ·ÐºÐ¸'];\n  const cancelStatuses = ['Ð¾Ñ‚Ð¼ÐµÐ½Ñ‘Ð½', 'Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½', 'Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚'];\n\n  filteredRecords.forEach(record => {\n    const sku = record.sku;\n    const status = record.status.toLowerCase();\n    const quantity = record.quantity || 1;\n    const price = record.price || 0;\n    \n    if (!statsBySku[sku]) {\n      statsBySku[sku] = {\n        totalOrders: 0,\n        cancellations: 0,\n        totalRevenue: 0,\n        weightedPriceSum: 0,\n        weightedQuantitySum: 0,\n        avgPrice: 0\n      };\n    }\n    \n    statsBySku[sku].totalOrders += quantity;\n    \n    if (cancelStatuses.some(s => status.includes(s))) {\n      statsBySku[sku].cancellations += quantity;\n    }\n    \n    if (revenueStatuses.some(s => status.includes(s))) {\n      statsBySku[sku].totalRevenue += price * quantity;\n      statsBySku[sku].weightedPriceSum += price * quantity;\n      statsBySku[sku].weightedQuantitySum += quantity;\n    }\n  });\n\n  Object.keys(statsBySku).forEach(sku => {\n    const stats = statsBySku[sku];\n    if (stats.weightedQuantitySum > 0) {\n      stats.avgPrice = stats.weightedPriceSum / stats.weightedQuantitySum;\n    }\n  });\n\n  let totalOrders = 0, totalCancellations = 0, totalRevenue = 0;\n  Object.values(statsBySku).forEach(stats => {\n    totalOrders += stats.totalOrders;\n    totalCancellations += stats.cancellations;\n    totalRevenue += stats.totalRevenue;\n  });\n\n  return { date, startTime, endTime, totalOrders, totalCancellations, totalRevenue, skuStats: statsBySku };\n}\n\nfunction formatStatisticsMessage(stats) {\n  let message = `ðŸ“Š **Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð·Ð°ÐºÐ°Ð·Ð¾Ð²**\\n\\n`;\n  message += `ðŸ“… Ð”Ð°Ñ‚Ð°: ${stats.date}\\n`;\n  message += `â° Ð’Ñ€ÐµÐ¼Ñ: ${stats.startTime} - ${stats.endTime}\\n\\n`;\n\n  if (stats.totalOrders === 0) {\n    message += stats.message || 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';\n    return message;\n  }\n\n  const sortedSkus = Object.keys(stats.skuStats).sort();\n  sortedSkus.forEach(sku => {\n    const skuStats = stats.skuStats[sku];\n    message += `**${sku}**\\n`;\n    message += `  â€¢ Ð—Ð°ÐºÐ°Ð·Ð¾Ð²: ${skuStats.totalOrders}\\n`;\n    message += `  â€¢ ÐžÑ‚Ð¼ÐµÐ½: ${skuStats.cancellations}\\n`;\n    message += `  â€¢ Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ñ†ÐµÐ½Ð°: ${skuStats.avgPrice.toFixed(2)} â‚½\\n`;\n    message += `  â€¢ Ð¡ÑƒÐ¼Ð¼Ð°: ${skuStats.totalRevenue.toFixed(2)} â‚½\\n\\n`;\n  });\n\n  message += `**Ð˜Ð¢ÐžÐ“Ðž:**\\n`;\n  message += `  â€¢ Ð’ÑÐµÐ³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²: ${stats.totalOrders}\\n`;\n  message += `  â€¢ Ð’ÑÐµÐ³Ð¾ Ð¾Ñ‚Ð¼ÐµÐ½: ${stats.totalCancellations}\\n`;\n  message += `  â€¢ ÐžÐ±Ñ‰Ð°Ñ ÑÑƒÐ¼Ð¼Ð°: ${stats.totalRevenue.toFixed(2)} â‚½\\n`;\n\n  return message;\n}\n\n// Main execution\nconst parsedData = $input.first().json;\nconst date = $json.selectedDate || parsedData.availableDates[0];\nconst startTime = $json.startTime || '00:00';\nconst endTime = $json.endTime || '23:59';\n\nconst stats = calculateStatistics(parsedData.records, date, startTime, endTime);\nconst message = formatStatisticsMessage(stats);\n\nreturn [{\n  json: {\n    chat_id: parsedData.chat_id,\n    text: message,\n    stats: stats,\n    parsed_data: parsedData\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2440,
        600
      ],
      "id": "calc-stats-node",
      "name": "Calculate Statistics"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2660,
        600
      ],
      "id": "send-statistics",
      "name": "Send Statistics",
      "credentials": {
        "telegramApi": {
          "id": "p4dTUZho7h1VsmzM",
          "name": "Tg Ozon.Orders bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=ozon:cache:{{ $json.user_id }}:csv_data",
        "value": "={{ JSON.stringify($json) }}",
        "options": {
          "ttl": 3600
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2220,
        540
      ],
      "id": "cache-to-redis",
      "name": "Cache to Redis",
      "credentials": {
        "redis": {
          "id": "kaA0Glj8bB5pwqRt",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const callbackData = $('Extract User Data').first().json.callback_data;\nconst selectedDate = callbackData.replace('date:', '');\nconst userId = $('Extract User Data').first().json.user_id;\n\nreturn [{\n  json: {\n    selectedDate: selectedDate,\n    user_id: userId,\n    chat_id: $('Extract User Data').first().json.chat_id,\n    startTime: '00:00',\n    endTime: '23:59'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        600
      ],
      "id": "handle-date-callback",
      "name": "Handle Date Callback"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=ozon:cache:{{ $json.user_id }}:csv_data",
        "propertyName": "value"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1780,
        600
      ],
      "id": "get-cached-data",
      "name": "Get Cached Data",
      "credentials": {
        "redis": {
          "id": "kaA0Glj8bB5pwqRt",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const dateSelection = $input.first().json;\nconst cachedData = JSON.parse($input.last().json.value || '{}');\n\nreturn [{\n  json: {\n    ...cachedData,\n    selectedDate: dateSelection.selectedDate,\n    startTime: dateSelection.startTime,\n    endTime: dateSelection.endTime,\n    chat_id: dateSelection.chat_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        600
      ],
      "id": "merge-selection-data",
      "name": "Merge Selection with Data"
    },
    {
      "parameters": {
        "jsCode": "// ðŸ” ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð”ÐžÐ¡Ð¢Ð£ÐŸÐ\n\nconst whitelistValue = $json.value;\nconst userId = $('Extract User Data').first().json.user_id;\nconst configSuperusers = $('Config').first().json.SUPERUSER_IDS || '';\n\nconst superuserIds = configSuperusers.split(',').map(id => id.trim()).filter(id => id);\n\nconst isSuperuser = superuserIds.includes(userId);\nconst isAdmin = whitelistValue === '1';\n\nif (!isSuperuser && !isAdmin) {\n  throw new Error('â›” Access denied. Only superusers and admins can use this bot.');\n}\n\nreturn {\n  json: {\n    ...$('Extract User Data').first().json,\n    is_superuser: isSuperuser,\n    is_admin: isAdmin,\n    redis_value: whitelistValue\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        790,
        300
      ],
      "id": "validate-whitelist-code",
      "name": "Validate Whitelist"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst inlineKeyboard = input.reply_markup?.inline_keyboard || [];\nreturn [{\n  json: {\n    chat_id: input.chat_id,\n    text: input.text,\n    reply_markup: { inline_keyboard: inlineKeyboard }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        60
      ],
      "id": "prepare-menu-msg",
      "name": "Prepare Menu"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').first().json.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        60
      ],
      "id": "send-menu-http",
      "name": "Send Menu"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst inlineKeyboard = input.reply_markup?.inline_keyboard || [];\nreturn [{\n  json: {\n    chat_id: input.chat_id,\n    text: input.text,\n    reply_markup: { inline_keyboard: inlineKeyboard }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        240
      ],
      "id": "prepare-menu-response-msg",
      "name": "Prepare Menu Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').first().json.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        240
      ],
      "id": "send-menu-response-http",
      "name": "Send Menu Response"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst inlineKeyboard = input.reply_markup?.inline_keyboard || [];\nreturn [{\n  json: {\n    chat_id: input.chat_id,\n    text: input.text,\n    reply_markup: { inline_keyboard: inlineKeyboard }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        240
      ],
      "id": "prepare-date-selection-msg",
      "name": "Prepare Date Selection"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Config').first().json.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2440,
        240
      ],
      "id": "send-date-selection-http",
      "name": "Send Date Selection"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').first().json.message.document.file_id }}",
        "additionalFields": { "download": true }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1200,
        500
      ],
      "id": "get-file-telegram-node",
      "name": "Get File from Telegram",
      "credentials": {
        "telegramApi": {
          "id": "p4dTUZho7h1VsmzM",
          "name": "Tg Ozon.Orders bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          { "node": "Config", "type": "main", "index": 0 }
        ]
      ]
    },
    "Extract User Data": {
      "main": [
        [
          { "node": "Check Whitelist", "type": "main", "index": 0 }
        ]
      ]
    },
    "Check Whitelist": {
      "main": [
        [
          { "node": "Validate Whitelist", "type": "main", "index": 0 }
        ]
      ]
    },
    "Is Authorized?": {
      "main": [
        [
          { "node": "Check Admin", "type": "main", "index": 0 }
        ],
        [
          { "node": "Unauthorized Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Check Admin": {
      "main": [
        [
          { "node": "Route Message", "type": "main", "index": 0 }
        ]
      ]
    },
    "Route Message": {
      "main": [
        [
          { "node": "Generate Main Menu", "type": "main", "index": 0 }
        ],
        [
          { "node": "Get File from Telegram", "type": "main", "index": 0 }
        ],
        [
          { "node": "Handle Menu", "type": "main", "index": 0 }
        ],
        [
          { "node": "Handle Date Callback", "type": "main", "index": 0 }
        ]
      ]
    },
    "Generate Main Menu": {
      "main": [
        [
          { "node": "Prepare Menu", "type": "main", "index": 0 }
        ]
      ]
    },
    "Handle Menu": {
      "main": [
        [
          { "node": "Prepare Menu Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Parse CSV": {
      "main": [
        [
          { "node": "Cache to Redis", "type": "main", "index": 0 }
        ]
      ]
    },
    "Generate Date Keyboard": {
      "main": [
        [
          { "node": "Prepare Date Selection", "type": "main", "index": 0 }
        ]
      ]
    },
    "Cache to Redis": {
      "main": [
        [
          { "node": "Generate Date Keyboard", "type": "main", "index": 0 }
        ]
      ]
    },
    "Handle Date Callback": {
      "main": [
        [
          { "node": "Get Cached Data", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get Cached Data": {
      "main": [
        [
          { "node": "Merge Selection with Data", "type": "main", "index": 0 }
        ]
      ]
    },
    "Merge Selection with Data": {
      "main": [
        [
          { "node": "Calculate Statistics", "type": "main", "index": 0 }
        ]
      ]
    },
    "Calculate Statistics": {
      "main": [
        [
          { "node": "Send Statistics", "type": "main", "index": 0 }
        ]
      ]
    },
    "Validate Whitelist": {
      "main": [
        [
          { "node": "Is Authorized?", "type": "main", "index": 0 }
        ]
      ]
    },
    "Prepare Menu": {
      "main": [
        [
          { "node": "Send Menu", "type": "main", "index": 0 }
        ]
      ]
    },
    "Prepare Menu Response": {
      "main": [
        [
          { "node": "Send Menu Response", "type": "main", "index": 0 }
        ]
      ]
    },
    "Prepare Date Selection": {
      "main": [
        [
          { "node": "Send Date Selection", "type": "main", "index": 0 }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          { "node": "Parse CSV", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get File from Telegram": {
      "main": [
        [
          { "node": "Extract from File", "type": "main", "index": 0 }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          { "node": "Validate Config", "type": "main", "index": 0 }
        ]
      ]
    },
    "Validate Config": {
      "main": [
        [
          { "node": "Extract User Data", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "pinData": {},
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1-patched",
  "meta": {
    "instanceId": "ozon-bot-instance"
  },
  "tags": []
}
