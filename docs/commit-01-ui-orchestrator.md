# Commit 01 ‚Äî fix(calendar): dedupe calendar messages via editMessageText + store message_id

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

- –í–≤–æ–¥–∏—Ç –µ–¥–∏–Ω—ã–π UI-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º–∞: send-or-edit.
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç/—á–∏—Ç–∞–µ—Ç message_id –ø–∞–Ω–µ–ª–∏ –∏–∑ Redis –∫–ª—é—á–∞ `ozon:ui:<uid>:<key>:message_id`.
- –£—Å—Ç—Ä–∞–Ω—è–µ—Ç ¬´–ø—Ä–æ—Å—Ç—ã–Ω—é¬ª —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–º–µ–Ω—é.

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

1) **–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π** `workflows/ui_orchestrator.n8n.json` –≤ n8n 1.113.3 (Create ‚Üí Import from file).

2) **–ö—Ä–µ–¥—ã Redis** —É–∂–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã: `kaA0Glj8bB5pwqRt` (–≤–∑—è—Ç—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ workflow).

3) **–£–±–µ–¥–∏—Å—å**, —á—Ç–æ –Ω–æ–¥–∞ `Config` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `TELEGRAM_BOT_TOKEN`.

4) **–í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ —Ä–∞–Ω—å—à–µ –±—ã–ª sendMessage –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–º–µ–Ω—é**:
   - –°—Ñ–æ—Ä–º–∏—Ä—É–π JSON:
     ```json
     {
       "chat_id": {{ chatId }},
       "user_id": {{ userId }},
       "key": "calendar",
       "text": "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã‚Ä¶",
       "reply_markup": { "inline_keyboard": [ [ { "text": "‚Äî", "callback_data": "noop" } ] ] },
       "parse_mode": "HTML"
     }
     ```
   - –í—ã–∑–æ–≤–∏ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É `ui_orchestrator (send-or-edit)` —Å —ç—Ç–∏–º JSON —á–µ—Ä–µ–∑ Execute Workflow node.

5) **–ü—Ä–æ–≤–µ—Ä—å /menu:orders**:
   - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è ¬´–∂–∏–≤–æ–µ¬ª —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è id (Redis).
   - –ü—Ä–∏ –∫–ª–∏–∫–∞—Ö –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏/–¥–∞—Ç–∞–º ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è **—Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è** –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É

```
Input: { chat_id, user_id, key, text, reply_markup, parse_mode? }
  ‚Üì
Compute Redis Keys (—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç uiKey = ozon:ui:<user_id>:<key>:message_id)
  ‚Üì
Redis Get UI Msg Id (—á–∏—Ç–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π message_id)
  ‚Üì
Has Msg Id? (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ)
  ‚îú‚îÄ true ‚Üí Telegram editMessageText (continueOnFail: true)
  ‚îÇ           ‚Üì
  ‚îÇ         Check Edit Result
  ‚îÇ           ‚îú‚îÄ ok=true ‚Üí Redis Set UI Msg Id (–æ–±–Ω–æ–≤–ª—è–µ–º TTL)
  ‚îÇ           ‚îî‚îÄ error ‚Üí Edit Failed ‚Üí Send? ‚Üí Telegram sendMessage (fallback)
  ‚îÇ                                            ‚Üì
  ‚îÇ                                          Wrap Send Result
  ‚îÇ                                            ‚Üì
  ‚îÇ                                          Redis Set UI Msg Id
  ‚îî‚îÄ false ‚Üí Telegram sendMessage (fallback/new)
               ‚Üì
             Wrap Send Result
               ‚Üì
             Redis Set UI Msg Id
```

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **continueOnFail: true** –Ω–∞ editMessageText ‚Äî –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –Ω–µ –ª–æ–º–∞–µ–º flow.
2. **Check Edit Result** –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç Telegram:
   - `ok: true` ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ, message_id –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
   - `ok: false` –∏–ª–∏ error ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ sendMessage
3. **Redis key**: `ozon:ui:<user_id>:<key>:message_id` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤.

## –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–±—ã—Å—Ç—Ä—ã–π —á–µ–∫-–ª–∏—Å—Ç)

- ‚úÖ –û—Ç–∫—Ä–æ–π ¬´–ó–∞–∫–∞–∑—ã¬ª ‚Üí –Ω–∞–∂–º–∏ ¬´–ö–∞–ª–µ–Ω–¥–∞—Ä—å¬ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- ‚úÖ **–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –≤ —á–∞—Ç–µ –æ—Å—Ç–∞—ë—Ç—Å—è **–æ–¥–Ω–æ** —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è), –Ω–æ–≤—ã–µ –Ω–µ –ø–ª–æ–¥—è—Ç—Å—è
- ‚úÖ –ï—Å–ª–∏ —É–¥–∞–ª–∏—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤—Ä—É—á–Ω—É—é ‚Üí —Å–ª–µ–¥—É—é—â–∏–π –∫–ª–∏–∫ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤–æ–µ (fallback —Ä–∞–±–æ—Ç–∞–µ—Ç)

## –°–≤—è–∑—å —Å –ø–ª–∞–Ω–æ–º

- ‚úÖ **–†–∞–∑–±–∏–≤–∫–∞** Send Date Selection –Ω–∞ Ensure Calendar Msg + Send or Edit Calendar
- ‚úÖ **–î–µ-–¥—É–ø–ª–∏–∫–∞—Ç–æ—Ä** —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ editMessageText
- ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ** calendar_msg_id –≤ Redis (—Ç–µ–ø–µ—Ä—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª—é—á `ozon:ui:*`)
- üîú –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–º–º–∏—Ç–µ ‚Ññ2

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–π flow:
- **–ö–æ–º–º–∏—Ç ‚Ññ2**: –î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞–ª–∏–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
- **–ö–æ–º–º–∏—Ç ‚Ññ3**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ui_orchestrator –≤ —Ç–æ—á–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–º–µ–Ω—é
- **–ö–æ–º–º–∏—Ç ‚Ññ4**: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
