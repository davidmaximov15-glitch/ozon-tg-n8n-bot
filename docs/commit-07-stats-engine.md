# Commit 07 ‚Äî feat(stats): Orders Stats Engine (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç)

## –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–≤–∏–∂–æ–∫ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –ø–æ SKU –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
–ë–µ—Ä—ë–º —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ Redis (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ CSV), —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º –≤ MSK, —Å—á–∏—Ç–∞–µ–º –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ SKU, —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML-–æ—Ç—á—ë—Ç.

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ß—Ç–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
```javascript
// –ß–∏—Ç–∞–µ–º –∏–∑ ozon:sess:<uid>:csv ‚Üí { records, availableDates, ... }
const meta = JSON.parse($('Get CSV Session (records)').first().json.value);
const records = meta.records; // —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ
```

### 2. –ö–æ–Ω–≤–µ—Ä—Å–∏—è UTC ‚Üí MSK
```javascript
function parseUtcToMsk(dateStr) {
  const t = Date.parse(dateStr);
  if (Number.isFinite(t)) {
    const d = new Date(t);
    const msk = new Date(d.getTime() + 3*60*60*1000); // UTC+3
    return msk;
  }
  return null;
}
```

**–ò–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
> "–û—Ç—á—ë—Ç—ã Ozon: created_at –≤ UTC. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ú–æ—Å–∫–≤–∞ (MSK). –ö–æ–Ω–≤–µ—Ä—Å–∏—è: –¥–æ–±–∞–≤–∏—Ç—å +3 —á–∞—Å–∞."

### 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º
```javascript
const selectedSet = new Set(selectedDates); // ["2025-10-02", "2025-10-07"]

const filtered = [];
for(const r of records) {
  const d = parseUtcToMsk(r.created_at);
  if (!d) continue;
  const day = d.toISOString().slice(0,10); // "2025-10-07"
  if (!selectedSet.has(day)) continue;
  filtered.push({ sku, quantity, price, status, date: day });
}
```

### 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)

**–í—ã—Ä—É—á–µ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**
```javascript
const STATUS_REVENUE = new Set([
  '–¥–æ—Å—Ç–∞–≤–ª–µ–Ω',
  '–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è',
  '–æ–∂–∏–¥–∞–µ—Ç —Å–±–æ—Ä–∫–∏',
  '–æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≥—Ä—É–∑–∫–∏'
]);
```

**–°—Ç–∞—Ç—É—Å—ã –æ—Ç–º–µ–Ω (–≤–∫–ª—é—á–∞—è –≤–æ–∑–≤—Ä–∞—Ç—ã!):**
```javascript
const STATUS_CANCELS = new Set([
  '–æ—Ç–º–µ–Ω—ë–Ω',
  '–≤–æ–∑–≤—Ä–∞—Ç'  // ‚Üê –≤–æ–∑–≤—Ä–∞—Ç—ã –≤—Ö–æ–¥—è—Ç –≤ –æ—Ç–º–µ–Ω—ã!
]);
```

**–ò–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
> "–í–æ–∑–≤—Ä–∞—Ç—ã –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –æ–±—â—É—é —Å—É–º–º—É –æ—Ç–º–µ–Ω (–Ω–µ –≤—ã–¥–µ–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)."

### 5. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ SKU

```javascript
const bySku = new Map();

for(const row of filtered) {
  if(!bySku.has(row.sku)) {
    bySku.set(row.sku, {
      totalOrders: 0,
      cancellations: 0,
      qtyForAvg: 0,      // –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã
      sumForAvg: 0,      // –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã
      totalRevenue: 0
    });
  }
  
  const agg = bySku.get(row.sku);
  
  // –í—ã—Ä—É—á–µ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
  if(STATUS_REVENUE.has(row.status)) {
    agg.totalOrders += row.quantity;
    agg.qtyForAvg   += row.quantity;
    agg.sumForAvg   += row.price * row.quantity;
    agg.totalRevenue += row.price * row.quantity;
  }
  
  // –û—Ç–º–µ–Ω—ã/–≤–æ–∑–≤—Ä–∞—Ç—ã
  if(STATUS_CANCELS.has(row.status)) {
    agg.cancellations += row.quantity;
  }
}
```

### 6. –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)

```javascript
const avgPrice = agg.qtyForAvg > 0 
  ? agg.sumForAvg / agg.qtyForAvg 
  : 0;
```

**–ò–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
> "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: sum(price * quantity) / sum(quantity) –ø–æ –≤—ã—Ä—É—á–µ—á–Ω—ã–º —Å—Ç–∞—Ç—É—Å–∞–º."

### 7. –ò—Ç–æ–≥–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã

```javascript
let tOrders = 0, tCanc = 0, tRev = 0;

for(const [sku, a] of bySku.entries()) {
  const avgPrice = a.qtyForAvg > 0 ? a.sumForAvg / a.qtyForAvg : 0;
  skuStats[sku] = {
    totalOrders: a.totalOrders,
    cancellations: a.cancellations,
    avgPrice,
    totalRevenue: a.totalRevenue
  };
  
  tOrders += a.totalOrders;
  tCanc += a.cancellations;
  tRev += a.totalRevenue;
}
```

### 8. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-–æ—Ç—á—ë—Ç–∞

```javascript
function fmt(s) {
  let m = `üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</b>\n\n`;
  const dates = Array.isArray(s.date) ? s.date.join(', ') : s.date;
  m += `üìÖ –î–∞—Ç—ã: ${dates||'‚Äî'}\n`;
  m += `‚è∞ –í—Ä–µ–º—è: ${s.startTime||'00:00'} - ${s.endTime||'24:00'}\n\n`;
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  if((s.totalOrders||0) === 0 && (s.totalCancellations||0) === 0) {
    m += '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º';
    return m;
  }
  
  // –î–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É SKU
  const keys = Object.keys(s.skuStats||{}).sort();
  for(const k of keys) {
    const x = s.skuStats[k];
    m += `<b>${k}</b>\n`;
    m += `  ‚Ä¢ –ó–∞–∫–∞–∑–æ–≤: ${x.totalOrders}\n`;
    m += `  ‚Ä¢ –û—Ç–º–µ–Ω: ${x.cancellations}\n`;
    m += `  ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: ${x.avgPrice.toFixed(2)} ‚ÇΩ\n`;
    m += `  ‚Ä¢ –°—É–º–º–∞: ${x.totalRevenue.toFixed(2)} ‚ÇΩ\n\n`;
  }
  
  // –ò—Ç–æ–≥–∏
  m += `<b>–ò–¢–û–ì–û:</b>\n`;
  m += `  ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${s.totalOrders}\n`;
  m += `  ‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–º–µ–Ω: ${s.totalCancellations}\n`;
  m += `  ‚Ä¢ –û–±—â–∞—è —Å—É–º–º–∞: ${s.totalRevenue.toFixed(2)} ‚ÇΩ`;
  
  return m;
}
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
INPUT –æ—Ç dates_done_guard_and_handoff:
  { user_id, chat_id, selectedDates, session }
         ‚Üì
Get CSV Session (records)
  ‚Ä¢ Redis: ozon:sess:<uid>:csv
  ‚Ä¢ –ò–∑–≤–ª–µ–∫–∞–µ–º { records, availableDates, ... }
         ‚Üì
Calculate Stats
  ‚Ä¢ –§–∏–ª—å—Ç—Ä: records ‚Üí —Ç–æ–ª—å–∫–æ selectedDates (MSK)
  ‚Ä¢ –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ SKU:
    - totalOrders (–ø–æ STATUS_REVENUE)
    - cancellations (–ø–æ STATUS_CANCELS)
    - avgPrice (—Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)
    - totalRevenue (sum price*qty)
  ‚Ä¢ –ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã
         ‚Üì
Format Message
  ‚Ä¢ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏
  ‚Ä¢ –î–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É SKU + –∏—Ç–æ–≥–∏
  ‚Ä¢ –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Üí "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º"
         ‚Üì
Telegram sendMessage (stats)
  ‚Ä¢ –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å)
  ‚Ä¢ parse_mode: HTML
```

## –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –û—Ç dates_done_guard_and_handoff (commit #6):
```json
{
  "user_id": 123456,
  "chat_id": 123456,
  "selectedDates": ["2025-10-02", "2025-10-07", "2025-10-15"],
  "session": {
    "from": "2025-09-01",
    "to": "2025-10-15",
    "months": ["2025-09", "2025-10"],
    "daysByMonth": { ... },
    "csv_key": "user:123456:uploads:abc123.csv"
  }
}
```

### –ò–∑ Redis (ozon:sess:<uid>:csv):
```json
{
  "reportType": "FBO",
  "records": [
    {
      "created_at": "2025-10-02T14:30:00",
      "sku": "SKU-12345",
      "quantity": 2,
      "price": 1500,
      "status": "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
    },
    {
      "created_at": "2025-10-07T09:15:00",
      "sku": "SKU-67890",
      "quantity": 1,
      "price": 2500,
      "status": "–æ—Ç–º–µ–Ω—ë–Ω"
    }
  ],
  "availableDates": ["2025-10-02", "2025-10-07", ...],
  "totalRecords": 150
}
```

## –§–æ—Ä–º–∞—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞

### –ü—Ä–∏–º–µ—Ä —Å –¥–∞–Ω–Ω—ã–º–∏:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤

üìÖ –î–∞—Ç—ã: 2025-10-02, 2025-10-07, 2025-10-15
‚è∞ –í—Ä–µ–º—è: 00:00 - 24:00

SKU-12345
  ‚Ä¢ –ó–∞–∫–∞–∑–æ–≤: 15
  ‚Ä¢ –û—Ç–º–µ–Ω: 2
  ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: 1450.50 ‚ÇΩ
  ‚Ä¢ –°—É–º–º–∞: 21757.50 ‚ÇΩ

SKU-67890
  ‚Ä¢ –ó–∞–∫–∞–∑–æ–≤: 8
  ‚Ä¢ –û—Ç–º–µ–Ω: 1
  ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: 2300.00 ‚ÇΩ
  ‚Ä¢ –°—É–º–º–∞: 18400.00 ‚ÇΩ

–ò–¢–û–ì–û:
  ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: 23
  ‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–º–µ–Ω: 3
  ‚Ä¢ –û–±—â–∞—è —Å—É–º–º–∞: 40157.50 ‚ÇΩ
```

### –ü—Ä–∏–º–µ—Ä –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤

üìÖ –î–∞—Ç—ã: 2025-10-02
‚è∞ –í—Ä–µ–º—è: 00:00 - 24:00

–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º
```

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)

### 1. –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤—Ä–µ–º–µ–Ω–∏
‚úÖ **UTC ‚Üí MSK:** `created_at` –≤ –æ—Ç—á—ë—Ç–∞—Ö UTC, –¥–æ–±–∞–≤–ª—è–µ–º +3 —á–∞—Å–∞ –¥–ª—è MSK

### 2. –°—Ç–∞—Ç—É—Å—ã –≤—ã—Ä—É—á–∫–∏
‚úÖ **STATUS_REVENUE:**
- –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
- –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
- –æ–∂–∏–¥–∞–µ—Ç —Å–±–æ—Ä–∫–∏
- –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≥—Ä—É–∑–∫–∏

### 3. –°—Ç–∞—Ç—É—Å—ã –æ—Ç–º–µ–Ω
‚úÖ **STATUS_CANCELS (–≤–∫–ª—é—á–∞—è –≤–æ–∑–≤—Ä–∞—Ç—ã!):**
- –æ—Ç–º–µ–Ω—ë–Ω
- –≤–æ–∑–≤—Ä–∞—Ç

### 4. –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞
‚úÖ **–§–æ—Ä–º—É–ª–∞:** `sum(price * quantity) / sum(quantity)`
- –°—á–∏—Ç–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –ø–æ –≤—ã—Ä—É—á–µ—á–Ω—ã–º —Å—Ç–∞—Ç—É—Å–∞–º
- –û—Ç–º–µ–Ω—ã/–≤–æ–∑–≤—Ä–∞—Ç—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–µ

### 5. –í—ã—Ä—É—á–∫–∞
‚úÖ **–§–æ—Ä–º—É–ª–∞:** `sum(price * quantity)` –ø–æ –≤—ã—Ä—É—á–µ—á–Ω—ã–º —Å—Ç–∞—Ç—É—Å–∞–º

### 6. –ê–≥—Ä–µ–≥–∞—Ü–∏—è
‚úÖ **–ü–æ SKU:** –ö–∞–∂–¥—ã–π SKU –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–∏ –º–µ—Ç—Ä–∏–∫–∏
‚úÖ **–û–±—â–∏–µ –∏—Ç–æ–≥–∏:** –°—É–º–º—ã –ø–æ –≤—Å–µ–º SKU

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤:

1. **files_session_and_clear** (–∫–æ–º–º–∏—Ç ‚Ññ2)
   - –î–æ–ª–∂–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å `records` –≤ `ozon:sess:<uid>:csv`
   - –§–æ—Ä–º–∞—Ç: `{ reportType, records[], availableDates[], totalRecords }`

2. **dates_done_guard_and_handoff** (–∫–æ–º–º–∏—Ç ‚Ññ6)
   - –í—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç workflow —Å –≤–∞–ª–∏–¥–Ω—ã–º –≤—Ö–æ–¥–æ–º
   - –ü–µ—Ä–µ–¥–∞—ë—Ç: `{ user_id, chat_id, selectedDates, session }`

### –°–≤—è–∑—å —Å –±—É–¥—É—â–∏–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏:

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ 2+ –¥–∞—Ç (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏):**
> "–ü—Ä–∏ –≤—ã–±–æ—Ä–µ 2+ –¥–∞—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ–ª—å—Ç—É –∏ % –∏–∑–º–µ–Ω–µ–Ω–∏—è"

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏: –±–∞–∑–æ–≤—ã–π –æ—Ç—á—ë—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –Ω–∞–±–æ—Ä—É –¥–∞—Ç.
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –¥–µ–ª—å—Ç—ã: —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–º–º–∏—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 1. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º
```bash
# Redis: –ø—É—Å—Ç—ã–µ records –∏–ª–∏ –Ω–µ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π
redis-cli GET "ozon:sess:123456:csv"
# ‚Üí {"records":[],...}

# –†–µ–∑—É–ª—å—Ç–∞—Ç: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º"
```

### 2. –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ 1 –¥–∞—Ç—É
```bash
# selectedDates: ["2025-10-07"]
# records: 5 –∑–∞–ø–∏—Å–µ–π —Å created_at –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å (MSK)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –û—Ç—á—ë—Ç —Å –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏ –ø–æ SKU + –∏—Ç–æ–≥–∏
```

### 3. –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ 3 –¥–∞—Ç—ã
```bash
# selectedDates: ["2025-10-02", "2025-10-07", "2025-10-15"]
# records: 50 –∑–∞–ø–∏—Å–µ–π –ø–æ —ç—Ç–∏–º –¥–∞—Ç–∞–º

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ SKU
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Ü–µ–Ω—ã
```
–ó–∞–ø–∏—Å–∏ –ø–æ SKU-12345:
  - 5 —à—Ç √ó 1000‚ÇΩ = 5000‚ÇΩ (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω)
  - 3 —à—Ç √ó 1500‚ÇΩ = 4500‚ÇΩ (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω)

–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞:
  (5000 + 4500) / (5 + 3) = 9500 / 8 = 1187.50‚ÇΩ
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –≤ –æ—Ç–º–µ–Ω–∞—Ö
```
–ó–∞–ø–∏—Å–∏ –ø–æ SKU-67890:
  - 10 —à—Ç (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω) ‚Üí totalOrders += 10
  - 2 —à—Ç (–æ—Ç–º–µ–Ω—ë–Ω) ‚Üí cancellations += 2
  - 1 —à—Ç (–≤–æ–∑–≤—Ä–∞—Ç) ‚Üí cancellations += 1
  
–ò—Ç–æ–≥: totalOrders=10, cancellations=3
```

## Edge cases

### –ù–µ—Ç records –≤ Redis
```javascript
meta = {}; records = [];
‚Üí filtered = [];
‚Üí skuStats = {};
‚Üí totalOrders = 0, totalCancellations = 0
‚Üí "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º"
```

### –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π created_at
```javascript
parseUtcToMsk("invalid") ‚Üí null
‚Üí –∑–∞–ø–∏—Å—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (continue)
```

### SKU –ø—É—Å—Ç–æ–π
```javascript
if(!row.sku) continue;
‚Üí –∑–∞–ø–∏—Å–∏ –±–µ–∑ SKU –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
```

### quantity –∏–ª–∏ price = 0
```javascript
quantity: Number(r.quantity||0) ‚Üí 0
price: Number(r.price||0) ‚Üí 0
‚Üí –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É–º–º—ã (0 * price = 0)
```

### –°—Ç–∞—Ç—É—Å –Ω–µ –≤ STATUS_REVENUE –∏ –Ω–µ –≤ STATUS_CANCELS
```javascript
status: "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ"
‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∏ –≤ –≤—ã—Ä—É—á–∫—É, –Ω–∏ –≤ –æ—Ç–º–µ–Ω—ã)
```

## –§–∞–π–ª—ã –∫–æ–º–º–∏—Ç–∞

```
workflows/
  ‚îî‚îÄ orders_stats_engine.n8n.json

docs/
  ‚îî‚îÄ commit-07-stats-engine.md (—ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ files_session_and_clear:
–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Redis `ozon:sess:<uid>:csv` **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –≤–∫–ª—é—á–∞—Ç—å:
```json
{
  "records": [
    {
      "created_at": "ISO timestamp (UTC)",
      "sku": "string",
      "quantity": number,
      "price": number,
      "status": "string (lowercase)"
    }
  ],
  "availableDates": [...],
  "totalRecords": number
}
```

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç dates_done_guard_and_handoff:
```json
{
  "user_id": number,
  "chat_id": number,
  "selectedDates": string[],
  "session": { ... }
}
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è UI (–∫–æ–º–º–∏—Ç ‚Ññ1)
- ‚úÖ –°–µ—Å—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ (–∫–æ–º–º–∏—Ç ‚Ññ2)
- ‚úÖ –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–∫–æ–º–º–∏—Ç ‚Ññ3)
- ‚úÖ –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —Å –ª–∏–º–∏—Ç–æ–º (–∫–æ–º–º–∏—Ç ‚Ññ4)
- ‚úÖ UX —É–ª—É—á—à–µ–Ω–∏—è (–∫–æ–º–º–∏—Ç ‚Ññ5)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–∫–æ–º–º–∏—Ç ‚Ññ6)
- ‚úÖ **–†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º (–∫–æ–º–º–∏—Ç ‚Ññ7)**

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ 2+ –¥–∞—Ç (–¥–µ–ª—å—Ç—ã –∏ %)
- –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞ –≤ CSV
- –ì—Ä–∞—Ñ–∏–∫–∏ —á–µ—Ä–µ–∑ Chart.js
- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ—Ç—á—ë—Ç–∞ (FBO/FBS)

**–ë–∞–∑–æ–≤—ã–π MVP –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π workflow!** üéâ
