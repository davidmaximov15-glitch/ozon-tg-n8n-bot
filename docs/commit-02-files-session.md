# Commit 02 ‚Äî feat(files): per-user file session + clear-file

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

1) **–ü–æ—Å–ª–µ `Parse Report File`** —Å—Ç—Ä–æ–∏—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é:
   - `from`, `to` ‚Äî –ø–µ—Ä–≤–∞—è/–ø–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –≤ –¥–∞–Ω–Ω—ã—Ö;
   - `months[]` ‚Äî —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –≤–∏–¥–∞ YYYY-MM;
   - `daysByMonth{YYYY-MM: [d,‚Ä¶]}` ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏;
   - `csv_key` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞.
   ‚Üí –∫–ª–∞–¥—ë–º –≤ `ozon:sess:<uid>:csv`.

2) **–ü—Ä–∏ –Ω–æ–≤–æ–º –∞–ø–ª–æ–∞–¥–µ**:
   - —á–∏—Å—Ç–∏–º `ozon:sess:<uid>:dates` –∏ `ozon:ui:<uid>:calendar_msg_id`, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

3) **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ `file:clear`**:
   - —É–¥–∞–ª—è–µ—Ç `ozon:sess:<uid>:csv`, `ozon:sess:<uid>:dates`, `ozon:ui:<uid>:calendar_msg_id`;
   - –æ—Ç–≤–µ—á–∞–µ—Ç `answerCallbackQuery('–ö—ç—à –æ—á–∏—â–µ–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç')`.

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

1. **–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π** `workflows/files_session_and_clear.n8n.json` –≤ n8n.

2. **–í –æ—Å–Ω–æ–≤–Ω–æ–º workflow** –ø–æ—Å–ª–µ —É–∑–ª–∞ **Parse Report File** –¥–æ–±–∞–≤—å –≤—ã–∑–æ–≤ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É **files_session_and_clear**:
   - –ò—Å–ø–æ–ª—å–∑—É–π Execute Workflow node
   - –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `Extract User Data` + `Parse Report File`

3. **–í —Ä–æ—É—Ç–∏–Ω–≥–µ callback'–æ–≤** –¥–æ–±–∞–≤—å –≤–µ—Ç–∫—É –Ω–∞ `file:clear`:
   - –í—ã–∑—ã–≤–∞–π —ç—Ç–æ—Ç –∂–µ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É
   - –û–Ω —Å–∞–º —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç `file:clear` —á–µ—Ä–µ–∑ —É–∑–µ–ª `Is file:clear?` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –æ—á–∏—Å—Ç–∫—É

4. **–ü—Ä–æ–≤–µ—Ä—å –º–µ–Ω—é ¬´–ó–∞–∫–∞–∑—ã¬ª**:
   - –ö–Ω–æ–ø–∫–∞ ¬´üóë –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª¬ª —É–∂–µ –µ—Å—Ç—å –≤ —Ç–µ–∫—É—â–µ–º workflow
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Ä–∞–±–æ—Ç–∞–µ—Ç:
     - –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Üí —Ç–æ—Å—Ç ¬´–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –æ—Ç—á—ë—Ç–∞¬ª
     - –µ—Å–ª–∏ –µ—Å—Ç—å ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è `initial month` –∏ —Ä–∏—Å—É–µ—Ç—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∞–±-–≤–æ—Ä–∫—Ñ–ª–æ—É

### –ß–∞—Å—Ç—å 1: Build File Session (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ CSV)

```
Parse Report File (availableDates[])
  ‚Üì
Build File Session (from meta)
  - –°—Ç—Ä–æ–∏—Ç: from, to, months[], daysByMonth{}
  - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç csv_key
  ‚Üì
Has Session? (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ dates –Ω–µ –ø—É—Å—Ç–æ–π)
  ‚îú‚îÄ YES ‚Üí Persist Session (ozon:sess:<uid>:csv)
  ‚îÇ           ‚Üì
  ‚îÇ         Del Selected Dates (reset) ‚Äî –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
  ‚îÇ           ‚Üì
  ‚îÇ         Del calendar_msg_id (reset) ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  ‚îî‚îÄ NO ‚Üí END (–Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º)
```

### –ß–∞—Å—Ç—å 2: Handle file:clear (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏)

```
Route Message ‚Üí callback_data = 'file:clear'
  ‚Üì
Is file:clear? (–ø—Ä–æ–≤–µ—Ä–∫–∞)
  ‚îú‚îÄ YES ‚Üí Del csv (session) ‚Äî —É–¥–∞–ª—è–µ–º ozon:sess:<uid>:csv
  ‚îÇ           ‚Üì
  ‚îÇ         Del selected_dates ‚Äî —É–¥–∞–ª—è–µ–º ozon:sess:<uid>:dates
  ‚îÇ           ‚Üì
  ‚îÇ         Del calendar_msg_id ‚Äî —É–¥–∞–ª—è–µ–º ozon:ui:<uid>:calendar_msg_id
  ‚îÇ           ‚Üì
  ‚îÇ         AnswerCallback (cleared) ‚Äî —Ç–æ—Å—Ç: "–ö—ç—à –æ—á–∏—â–µ–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç"
  ‚îî‚îÄ NO ‚Üí END
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–µ—Å—Å–∏–∏

```json
{
  "csv_key": "csv:123456:1704067200000",
  "from": "2025-09-18",
  "to": "2025-10-31",
  "months": ["2025-09", "2025-10"],
  "daysByMonth": {
    "2025-09": [18, 19, 20, 21, 25, 26, 27, 28],
    "2025-10": [1, 2, 3, 8, 9, 10, 15, 16, 17, 22, 23, 24, 29, 30, 31]
  }
}
```

## Redis –∫–ª—é—á–∏

| –ö–ª—é—á | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|-----------|
| `ozon:sess:<uid>:csv` | JSON —Å–µ—Å—Å–∏–∏ —Ñ–∞–π–ª–∞ | –•—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ CSV |
| `ozon:sess:<uid>:dates` | JSON –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç | –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ |
| `ozon:ui:<uid>:calendar_msg_id` | message_id | ID "–∂–∏–≤–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è |

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –≤–∫–∞—Ç–∞

- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ CSV**:
  - –í Redis –ø–æ—è–≤–ª—è–µ—Ç—Å—è `ozon:sess:<uid>:csv` —Å `{from, to, months, daysByMonth, csv_key}`
  - –í—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã (`ozon:sess:<uid>:dates`) ‚Äî –æ—á–∏—â–µ–Ω—ã
  - `calendar_msg_id` ‚Äî –æ—á–∏—â–µ–Ω

- ‚úÖ **menu:orders –±–µ–∑ —Ñ–∞–π–ª–∞**:
  - –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: ¬´–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –æ—Ç—á—ë—Ç–∞¬ª

- ‚úÖ **–ù–∞–∂–∞—Ç–∏–µ ¬´üóë –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª¬ª**:
  - –í—Å–µ —Ç—Ä–∏ –∫–ª—é—á–∞ —É–¥–∞–ª–µ–Ω—ã –∏–∑ Redis
  - –ü—Ä–∏—Ö–æ–¥–∏—Ç —Ç–æ—Å—Ç: ¬´–ö—ç—à –æ—á–∏—â–µ–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç¬ª

## –°–≤—è–∑—å —Å –ø–ª–∞–Ω–æ–º

- ‚úÖ **–°–µ—Å—Å–∏—è —Ñ–∞–π–ª–∞** `{csv_key, from, to, months[], daysByMonth{}}` –≤ `ozon:sess:<uid>:csv`
- ‚úÖ **–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `Has Session?`
- ‚úÖ **–ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏** —É–¥–∞–ª—è–µ—Ç `csv`, `dates`, `calendar_msg_id` –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ **–ú–µ–Ω—é ¬´–ó–∞–∫–∞–∑—ã¬ª** –≤—ã–≤–æ–¥–∏—Ç ¬´–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å¬ª –∏ ¬´–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª¬ª, –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤ –ø–æ `availableDates`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
- **–ö–æ–º–º–∏—Ç ‚Ññ3**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è `ui_orchestrator` –≤ —Ç–æ—á–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–º–µ–Ω—é
- **–ö–æ–º–º–∏—Ç ‚Ññ4**: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- **–ö–æ–º–º–∏—Ç ‚Ññ5**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
